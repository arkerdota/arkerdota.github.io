<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>火烧眉毛，我是如何在周六删了公司的数据库 | text</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><div class="darkmode-toggle">🌓</div><script>var prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)');
var toggle = document.querySelector('.darkmode-toggle');
var html = document.querySelector('html');

html.dataset.dark = localStorage.dark || prefersDarkMode.matches;

toggle.addEventListener('click', () => {
localStorage.dark = !(html.dataset.dark == 'true');
html.dataset.dark = localStorage.dark;
});</script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">火烧眉毛，我是如何在周六删了公司的数据库</h1><a id="logo" href="/.">text</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">火烧眉毛，我是如何在周六删了公司的数据库</h1><div class="post-meta">2024-01-10</div><a class="disqus-comment-count" href="/2024/01/10/%E7%81%AB%E7%83%A7%E7%9C%89%E6%AF%9B%EF%BC%8C%E6%88%91%E6%98%AF%E5%A6%82%E4%BD%95%E5%9C%A8%E5%91%A8%E5%85%AD%E5%88%A0%E4%BA%86%E5%85%AC%E5%8F%B8%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93/#waline"><span class="waline-comment-count" id="/2024/01/10/%E7%81%AB%E7%83%A7%E7%9C%89%E6%AF%9B%EF%BC%8C%E6%88%91%E6%98%AF%E5%A6%82%E4%BD%95%E5%9C%A8%E5%91%A8%E5%85%AD%E5%88%A0%E4%BA%86%E5%85%AC%E5%8F%B8%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93/"></span><span> Comment</span></a><div class="post-content"><p>原文<a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=https://zaidesanton.substack.com/p/how-i-destroyed-the-companys-db">链接</a>，作者：Anton Zaides。</p>
<hr>
<p>这本是一个安静的星期六。</p>
<p>我收到了支持团队的一条消息，说我们一个客户遇到了问题。我认为这个问题很重要，值得开始调试。15 分钟后，我明白了问题所在 - 在数据库中有一些损坏的订单需要删除。</p>
<p>听起来小菜一碟。</p>
<h2 id="事故还原"><a href="#事故还原" class="headerlink" title="事故还原"></a>事故还原</h2><p><em>如果你不给创业公司打工，请不要嘲笑我 😅</em></p>
<p>有几百个订单需要删除，所以我决定不手动操作，而是编写一个简单的 SQL 查询语句（警告 🚩）</p>
<p>实际上比这复杂一些，但这里简化一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">UPDATE orders</span><br><span class="line">SET is_deleted = true</span><br><span class="line"></span><br><span class="line">WHERE id in (1, 2, 3)</span><br></pre></td></tr></table></figure>

<p>你大概已经猜到这场灾难的规模了…</p>
<p>我按下了 CTRL + Enter 并运行了命令。当它花费超过一秒钟时，我明白发生了什么。我的客户端 DBeaver 看到空的第三行，并忽略了第四行。</p>
<p>是的，我删除了数据库中所有的订单 😢</p>
<p>我整个人都不好了。</p>
<h2 id="恢复"><a href="#恢复" class="headerlink" title="恢复"></a>恢复</h2><p>深吸一口气后，我知道我必须快速行动起来。不能犯更多错误浪费时间了。</p>
<p>恢复工作做得很好。</p>
<ol>
<li>停止系统 - 约 5 分钟</li>
<li>创建变更前数据库（幸运的是我们有 PITR）的克隆 - 约 20 分钟</li>
<li>在等待期间给我的老板打电话 😨</li>
<li>根据克隆更新生产数据库的信息 * - 约 15 分钟</li>
<li>启动系统 - 约 5 分钟</li>
</ol>
<p>* 我决定不还原整个数据库，因为无法停止所有系统，因为我们有多个独立的系统。我不想在恢复过程中丢失所做的更改。我们用 GCP 提供的托管 PostgreSQL，所以我从更新之前创建了一个新的克隆。然后，我只导出了克隆中的 <code>id</code> 和 <code>is_deleted</code> 列，并将结果导入到生产数据库中。之后，就是简单的 update + select 语句。</p>
<p>所以显然本可以很容易避免这 45 分钟的停机时间…</p>
<h2 id="发生了什么？"><a href="#发生了什么？" class="headerlink" title="发生了什么？"></a>发生了什么？</h2><p>这可能听起来像是一个你永远不会犯的愚蠢错误（甚至在大公司中，根本不能犯）。确实。问题不在于错误的 SQL 语句。** 一个小小的人为失误从来都不是真正的问题。** 我运行那个命令只是整个失败链条的终点。</p>
<ol>
<li>为什么要在周末处理生产环境？在这种情况下，事情并没有那么紧急。没有人要求我立即修复它。我本可以等到星期一再处理。</li>
<li>谁会在生产数据库上更改而不先在 QA 环境上运行一下呢？</li>
<li>为什么我手动编辑了数据库而不是通过调用 API？</li>
<li>如果没有 API，为什么我没打电话给队友，在如此敏感的操作上进行双重检查？</li>
<li>** 最糟糕的是，为什么我没使用事务？** 其实只要用了 Begin，万一出错时使用 Rollback 就可以了。</li>
</ol>
<p>错误一层层叠加，其中任何一个被避免了 - 整件事就不会发生。大多数问题答案都很简单：我太自信了。 不过还好通过有章法的恢复程序，阻止了连锁反应。想象一下如果无法将数据库恢复到正确状态会发生什么灾难……</p>
<h2 id="这与切尔诺贝利有什么关系？"><a href="#这与切尔诺贝利有什么关系？" class="headerlink" title="这与切尔诺贝利有什么关系？"></a>这与切尔诺贝利有什么关系？</h2><p>几个月前，我阅读了「切尔诺贝利：一部悲剧史」。那里发生的一系列错误使我想起了那个被诅咒的周末（并不是要低估或与切尔诺贝利灾难相比较）。</p>
<ol>
<li>RBMK 反应堆存在根本技术问题。</li>
<li>这个问题没有得到恰当传达。之前有涉及该问题的事件，但切尔诺贝利团队对此并不熟悉。</li>
<li>在安全检查期间，团队没有按程序操作。</li>
<li>爆炸后，苏联政府试图掩盖事实，从而大大加剧了损害程度。</li>
</ol>
<p><strong>谁应该负责？</strong></p>
<p>反应堆设计师？其他电厂团队未能传达他们遇到的问题？切尔诺贝利团队？苏联政府？</p>
<p>所有人都有责任。灾难从来不是由单一错误引起的，而是由一连串错误造成的。我们的工作就是尽早打断这条链条，并做到最好。</p>
<h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><p>我对周一与老板的谈话本没有什么期待。</p>
<p>但他让我惊讶：「确保不再发生这种情况。但是我更喜欢这样 - 你犯了错误是因为你专注并且喜欢快速行动。做得越多，砸得越多。」</p>
<p>那正是我需要听到的。如果以过于「亲切」的方式说：没关系，别担心，谢谢你修复它！我反而会感觉虚伪。另一方面，我已经感觉很糟糕了，所以没有必要进一步吐槽我。</p>
<p>从那时起：</p>
<ul>
<li>我们减少了对数据库直接访问的需求，并创建相关的 API。</li>
<li>我总是先在 QA 上运行查询（显而易见吧？没有比灾难更能教训人了）。</li>
<li>我与产品经理商量，了解真正紧急和可以等待的事项。</li>
<li>任何对生产环境进行更删改操作都需要两个人来完成。这实际上防止了其他错误！</li>
<li>我开始使用事务处理机制。</li>
</ul>
<h2 id="可以应用在你的团队中的经验教训"><a href="#可以应用在你的团队中的经验教训" class="headerlink" title="可以应用在你的团队中的经验教训"></a>可以应用在你的团队中的经验教训</h2><p>事发后，我和团队详细分享了过程，没有隐瞒任何事情，也没有淡化我的过错。 在责备他人和不追究责任之间有一个微妙的平衡。当你犯错误时，这是一个传递正确信息的好机会。</p>
<p>如果你道歉 1000 次，他们会认为你期望当事情发生在他们身上时，他们也需要给出同样的回应。</p>
<p>如果你一笑了之，并忽视其影响，他们会认为这是可以接受的。</p>
<p>如果你承担责任、学习并改进自己 - 他们也会以同样的方式行事。</p>
<p><img src="https://s2.loli.net/2024/01/11/3eRvhmH5L8c1ArQ.png" alt="file"></p>
<h2 id="总结一下"><a href="#总结一下" class="headerlink" title="总结一下"></a>总结一下</h2><ul>
<li>鼓励行动派，关心客户，并解决问题。这就是初创企业成功的方式。</li>
<li>当犯错时，要追究责任。一起理解如何避免这种情况发生。</li>
<li>没必要落井下石。有些人需要更多的责任感，而有些人则需要更多的鼓励。我倾向于以鼓励为主。</li>
</ul>
<p>顺便说一句，如果团队采用了 Bytebase 的话，这个事故是大概率可以被避免的，因为 Bytebase 有好几道防线：</p>
<ol>
<li>用户不能随意通过使用 DBeaver 这样的本地客户端直连数据库，而必须通过 Bytebase 提交变更工单。</li>
<li>变更工单的 SQL 会经过自动审查，如果影响范围有异常，会有提示。</li>
<li>变更工单只有通过人工审核后才能发布。</li>
</ol>
</div><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li></ul></div><div class="post-nav"><a class="pre" href="/2024/01/12/%E4%B8%80%E7%82%B9%E6%80%9D%E8%80%83/">一点思考</a><a class="next" href="/2024/01/04/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E5%A4%A7%E6%95%B0%E6%8D%AE%E4%B8%93%E4%B8%9A%E7%BB%83%E7%BA%A7%E6%8C%87%E5%8D%97/">大数据专业练级指南</a></div><div class="nofancybox" id="waline"></div><script src="//unpkg.com/@waline/client@v2/dist/waline.js"></script><link rel="stylesheet" type="text/css" href="//unpkg.com/@waline/client@v2/dist/waline.css"><script>let metaInfo = ['nick', 'mail', 'link']
let requiredMeta = 'nick'.split(',').filter(item => {
  return metaInfo.indexOf(item) > -1
})
Waline.init({
  el: '#waline',
  comment: true,
  serverURL: 'https://waline-test-fb79zz2td-arkerdotas-projects.vercel.app/',
  pageSize: '30',
  wordLimit: '500',
  requiredMeta,
})
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yangyining.cn"/></form></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="About"><img class="nofancybox" src="/img/avatar.png"/></a><p>To be a better man.</p><a class="info-icon" href="https://twitter.com/username" title="Twitter" target="_blank" style="margin-inline:5px"> <i class="fa fa-twitter-square" style="margin-inline:5px"></i></a><a class="info-icon" href="mailto:admin@domain.com" title="Email" target="_blank" style="margin-inline:5px"> <i class="fa fa-envelope-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/username" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a><a class="info-icon" href="/atom.xml" title="RSS" target="_blank" style="margin-inline:5px"> <i class="fa fa-rss-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/%E6%B5%8B%E8%AF%95%E5%8D%9A%E5%AE%A2/" style="font-size: 15px;">测试博客</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 15px;">数据库</a> <a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" style="font-size: 15px;">大数据</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2024/01/12/%E4%B8%80%E7%82%B9%E6%80%9D%E8%80%83/">一点思考</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/01/10/%E7%81%AB%E7%83%A7%E7%9C%89%E6%AF%9B%EF%BC%8C%E6%88%91%E6%98%AF%E5%A6%82%E4%BD%95%E5%9C%A8%E5%91%A8%E5%85%AD%E5%88%A0%E4%BA%86%E5%85%AC%E5%8F%B8%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93/">火烧眉毛，我是如何在周六删了公司的数据库</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/01/04/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E5%A4%A7%E6%95%B0%E6%8D%AE%E4%B8%93%E4%B8%9A%E7%BB%83%E7%BA%A7%E6%8C%87%E5%8D%97/">大数据专业练级指南</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/01/04/%E7%AC%AC%E4%B8%80%E7%AF%87%E5%8D%9A%E5%AE%A2/">第一篇博客</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/01/04/hello-world/">Hello World</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> Recent Comments</i></div><div id="widget-waline-list"></div><script type="text/javascript" id="recent-comment" serverURL="https://waline-test-fb79zz2td-arkerdotas-projects.vercel.app/" count="10" src="/js/recent-comments.js?v=1.0.0" async="async"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2024 <a href="/." rel="nofollow">text.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>